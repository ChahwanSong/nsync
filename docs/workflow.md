# Workflow

## 1) 스캔 단계

- Master는 `--src` 경로를 기준으로 디렉터리 트리를 순회합니다.
- `--master-scan-depth`로 최대 스캔 깊이를 제한합니다.
- 스캔 깊이에 도달하면 해당 디렉터리 자체를 **하위 파일을 대표하는 항목**으로 수집합니다.
- 각 파일에 대해 상대 경로와 파일 크기를 수집합니다.

## 2) 버킷 분배 및 배치 생성

- 수집된 파일 목록을 `num_master_processes` 개수만큼 버킷으로 분할합니다.
- 각 버킷을 별도 프로세스가 처리하여 배치 리스트를 생성합니다.
- 배치는 스트리밍 방식으로 생성되며, 만들어지는 즉시 Master 큐로 전송됩니다.
- 버킷 프로세스는 스캔 깊이에서 수집된 디렉터리를 다시 탐색하여 하위 파일을 포함합니다.
- 배치 생성 규칙:
  - `batch_num_files`를 초과하거나,
  - `batch_size`를 초과하는 경우 배치를 플러시합니다.
- 배치는 파일 경로 집합을 포함하며, 경로 압축 로직으로 상위 디렉터리로 축약될 수 있습니다.
- 배치에는 파일/디렉터리 수와 바이트 추정치가 포함되어 처리량 집계에 활용됩니다.

## 3) 배치 클레임

- Worker는 `claim` 요청을 REQ 소켓으로 전송합니다.
- Master는 배치 큐에서 배치를 꺼내 응답합니다.
- 모든 프로듀서가 종료되고 큐가 비어 있으면 `done` 상태를 반환합니다.
- Master는 배치를 큐에 넣는 시점에 `task_id`를 순차적으로 부여합니다.

## 4) rsync 실행

- Worker는 배치에 포함된 파일 리스트를 rsync로 동기화합니다.
- 단일 파일은 직접 경로 전송, 다중 파일은 `--files-from` 옵션을 사용합니다.
- 동기화 실패 시 지수 백오프로 재시도합니다.

## 5) 결과/헬스비트

- Worker는 결과를 `result` 채널로 전송합니다.
- 주기적인 `heartbeat` 이벤트를 `heartbeat` 채널로 전송합니다.
- Master는 결과 집계를 통해 진행률과 실패 현황을 제공합니다.
- 하트비트가 `heartbeat_timeout` 이상 끊기면 해당 워커가 클레임한 배치를 재큐잉합니다.

## 6) 종료 조건

- Master의 모든 배치가 완료되면 `exit_when_done` 옵션에 따라 정상 종료합니다.
- Worker는 `done` 상태를 수신하면 루프를 종료합니다.
