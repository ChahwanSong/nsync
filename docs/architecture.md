# 시스템 아키텍처

## 개요

nsync는 대용량 파일 트리를 효율적으로 동기화하기 위해 **Control Plane(운영/관측)** 과 **Data Plane(전송)** 을 분리한 구조를 사용합니다.

- **Control Plane**: FastAPI 기반 운영 API 및 상태 집계를 담당합니다.
- **Data Plane**: ZeroMQ 기반 메시징과 rsync 기반 전송으로 구성됩니다.

## 구성 요소

### Master

- 소스 디렉터리를 스캔해 파일 메타데이터를 수집합니다.
- 배치 생성 규칙(`batch_num_files`, `batch_size`)에 따라 작업을 분할합니다.
- 워커 클레임(REQ/REP) 요청을 수락하여 배치를 분배합니다.
- 결과/로그/헬스 정보를 수집하고 운영 API로 제공합니다.

### Worker

- Master로부터 배치를 클레임합니다.
- rsync로 파일을 전송합니다.
- 실패 시 지수 백오프 기반 재시도를 수행합니다.
- 결과와 헬스비트를 Master에 보고합니다.

### ZeroMQ 채널 맵

| 채널 | 소켓 패턴 | 방향 | 목적 | 기본 포트 |
| --- | --- | --- | --- | --- |
| Batch | PUSH → PULL | Master 프로듀서 → Master 수신 | 배치 전달 | 5556 |
| Claim | REQ → REP | Worker → Master | 배치 클레임 | 5555 |
| Result | PUSH → PULL | Worker → Master | 결과 보고 | 5557 |
| Heartbeat | PUSH → PULL | Worker → Master | 헬스비트 | 5558 |

FastAPI 운영 API는 기본 포트 8000을 사용합니다.

## 확장성/고가용성 고려사항

- **수평 확장**: 워커 프로세스 수를 늘려 데이터 플레인 처리량을 선형 확장할 수 있습니다.
- **분산 처리**: Master와 Worker를 별도 호스트에 배치해 네트워크 경계를 넘는 분산 실행이 가능합니다.
- **장애 격리**: 워커 실패는 배치 단위로 격리되며, 재시도 정책으로 복구합니다.
- **관측성**: FastAPI 운영 API는 진행률/처리량/로그/워커 상태를 제공하여 운영 중 모니터링에 활용할 수 있습니다.

## 데이터 흐름 요약

1. Master가 소스 디렉터리를 스캔합니다.
2. 배치 프로듀서가 배치를 생성해 Master 큐에 공급합니다.
3. 워커가 배치를 클레임하고 rsync로 전송합니다.
4. 워커는 결과를 Master에 보고합니다.
5. Master는 API로 집계 결과를 제공합니다.
